<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>Acme Console · 대시보드</title>
  <style>
    :root{
      --bg: #0b1020;          /* dark base */
      --panel: #0f152b;
      --panel-2:#111a33;
      --text:#e6e9f2;
      --muted:#9aa3b2;
      --brand:#6aa7ff;
      --brand-2:#8ad0ff;
      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --border: rgba(255,255,255,0.08);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    :root.light{
      --bg: #f6f7fb;          /* light base */
      --panel:#ffffff;
      --panel-2:#ffffff;
      --text:#111827;
      --muted:#536072;
      --brand:#1f6fff;
      --brand-2:#5ab6ff;
      --border: rgba(17, 24, 39, 0.08);
      --shadow: 0 6px 18px rgba(20, 30, 50, .08);
    }
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(180deg, var(--bg), #0b1327 40%, var(--bg));
      color:var(--text); font: 14px/1.55 system-ui, -apple-system, "Segoe UI", Roboto, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }
    .app{display:grid; grid-template-columns: 260px 1fr; grid-template-rows: 64px 1fr; min-height:100vh}
    .sidebar{grid-row:1 / span 2; grid-column:1; position:sticky; top:0; height:100vh; background:linear-gradient(180deg, #0b1327, #0a0f1e); border-right:1px solid var(--border);}
    .logo{display:flex; align-items:center; gap:10px; padding:16px 18px; border-bottom:1px solid var(--border)}
    .logo .badge{width:28px; height:28px; display:grid; place-items:center; background: radial-gradient(circle at 30% 20%, var(--brand), var(--brand-2)); color:#00122b; border-radius:8px; font-weight:900; box-shadow:var(--shadow)}
    .logo h1{font-size:15px; letter-spacing:.4px; margin:0}
    .nav{padding:12px}
    .nav h2{margin:14px 12px 6px; font-size:11px; color:var(--muted); letter-spacing:.08em; text-transform:uppercase}
    .nav a{display:flex; align-items:center; gap:10px; padding:10px 12px; margin:4px 0; color:inherit; text-decoration:none; border-radius:10px; border:1px solid transparent}
    .nav a:hover{background:rgba(255,255,255,.03); border-color:var(--border)}
    .nav a.active{background:linear-gradient(180deg, rgba(106,167,255,.16), rgba(138,208,255,.06)); border-color:rgba(106,167,255,.35)}
    .pill{font-size:11px; color:var(--text); background:rgba(255,255,255,.06); padding:1px 8px; border-radius:999px; margin-left:auto; border:1px solid var(--border)}

    .topbar{grid-column:2; display:flex; align-items:center; gap:12px; padding:10px 16px; background:rgba(255,255,255,.02); border-bottom:1px solid var(--border); position:sticky; top:0; z-index:20; backdrop-filter: blur(6px)}
    .search{flex:1; display:flex; align-items:center; gap:10px; background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:10px}
    .search input{flex:1; background:transparent; border:0; color:var(--text); outline:0}
    .btn, button{background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)); border:1px solid var(--border); color:var(--text); border-radius:10px; padding:8px 12px; cursor:pointer}
    .btn:hover{background:rgba(255,255,255,.06)}
    .avatar{width:28px; height:28px; border-radius:10px; display:grid; place-items:center; background:linear-gradient(180deg, #2a3557, #1b2542); border:1px solid var(--border); font-weight:700}

    .main{grid-column:2; padding:18px; display:grid; gap:16px}
    .breadcrumbs{display:flex; align-items:center; gap:8px; font-size:13px; color:var(--muted)}
    .title-row{display:flex; align-items:end; justify-content:space-between}
    .h1{font-size:24px; font-weight:800; letter-spacing:.2px}
    .sub{color:var(--muted)}

    .grid{display:grid; gap:16px}
    .kpis{grid-template-columns: repeat(4, minmax(0,1fr))}
    .cards{grid-template-columns: 1.2fr 1fr}
    .panels{grid-template-columns: 1fr 1fr}
    @media (max-width:1200px){.kpis{grid-template-columns: repeat(2,1fr)} .cards{grid-template-columns: 1fr} .panels{grid-template-columns: 1fr}}

    .card{background:var(--panel); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow)}
    .card .hd{display:flex; align-items:center; gap:12px; justify-content:space-between; padding:14px 14px 0}
    .card .hd .title{font-weight:700}
    .card .hd .muted{font-size:12px; color:var(--muted)}
    .card .bd{padding:14px}
    .kpi{display:flex; align-items:center; gap:14px}
    .kpi .num{font-size:22px; font-weight:800}
    .kpi .delta{font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--border)}
    .delta.up{color:var(--ok); background:rgba(34,197,94,.08)}
    .delta.down{color:var(--bad); background:rgba(239,68,68,.08)}
    .spark{width:150px; height:40px}

    .toolbar{display:flex; gap:8px; align-items:center}
    .divider{height:1px; background:var(--border); margin:8px 0}

    .table{width:100%; border-collapse:collapse}
    .table th, .table td{padding:10px 12px; border-bottom:1px solid var(--border)}
    .table th{font-size:12px; text-transform:uppercase; letter-spacing:.06em; color:var(--muted); position:sticky; top:0; background:var(--panel)}
    .status{display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; border:1px solid var(--border); font-size:12px}
    .status.ok{background:rgba(34,197,94,.08); color:var(--ok)}
    .status.warn{background:rgba(245,158,11,.08); color:var(--warn)}
    .status.bad{background:rgba(239,68,68,.08); color:var(--bad)}

    .timeline{position:relative; padding-left:22px}
    .timeline:before{content:""; position:absolute; left:10px; top:4px; bottom:4px; width:2px; background:linear-gradient(var(--brand), transparent)}
    .tl-item{margin:10px 0; position:relative}
    .tl-dot{position:absolute; left:-2px; top:4px; width:12px; height:12px; border-radius:999px; background:radial-gradient(circle at 30% 30%, var(--brand-2), var(--brand))}

    .footer{color:var(--muted); font-size:12px; padding:10px; text-align:center}

    /* sidebar collapse */
    .collapse-btn{display:none}
    @media (max-width:980px){
      .app{grid-template-columns: 1fr;}
      .sidebar{position:fixed; z-index:50; transform:translateX(-100%); transition:transform .25s ease}
      .sidebar.open{transform:none}
      .collapse-btn{display:inline-flex}
    }

    /* subtle animations */
    .fade-in{animation:fade .25s ease 1}
    @keyframes fade{from{opacity:.0; transform: translateY(6px)} to{opacity:1; transform:none}}
  </style>
</head>
<body>
<div class="app">
  <!-- SIDEBAR -->
  <aside id="sidebar" class="sidebar">
    <div class="logo">
      <div class="badge">A</div>
      <h1>Acme Console</h1>
    </div>
    <nav class="nav">
      <h2>메인</h2>
      <a class="active" href="#"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12l9-9 9 9"/><path d="M9 21V9h6v12"/></svg> 대시보드</a>
      <a href="#"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.3-4.3"/></svg> 분석</a>
      <a href="#"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M3 10h18"/></svg> 주문 <span class="pill">128</span></a>
      <a href="#"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> 고객</a>
      <a href="#"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z"/></svg> 마케팅</a>
      <h2>시스템</h2>
      <a href="#"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06A2 2 0 1 1 7.04 4.3l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c0 .64.38 1.22.96 1.51.21.11.45.17.69.17h.09a2 2 0 1 1 0 4h-.09c-.24 0-.48.06-.69.17-.58.29-.96.87-.96 1.51z"/></svg> 설정</a>
      <a href="#"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> 내보내기</a>
    </nav>
  </aside>

  <!-- TOPBAR -->
  <header class="topbar">
    <button class="btn collapse-btn" id="openSidebar">메뉴</button>
    <div class="search"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.3-4.3"/></svg><input id="q" placeholder="검색: 주문/고객/이벤트"/><button class="btn" id="searchBtn">검색</button></div>
    <div class="toolbar">
      <button class="btn" id="daterange">이번 달</button>
      <button class="btn" id="darkToggle">라이트/다크</button>
      <button class="btn" title="알림"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8a6 6 0 10-12 0c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg></button>
      <div class="avatar">JD</div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="main">
    <div class="breadcrumbs">홈 · <span>대시보드</span></div>
    <div class="title-row">
      <div>
        <div class="h1">운영 대시보드</div>
        <div class="sub">실시간 지표, 시스템 상태, 최근 트랜잭션</div>
      </div>
      <div class="toolbar">
        <button class="btn" id="refresh">데이터 새로고침</button>
        <button class="btn" id="exportCsv">CSV 내보내기</button>
      </div>
    </div>

    <!-- KPIs -->
    <section class="grid kpis">
      <div class="card fade-in">
        <div class="hd"><div class="title">매출 (오늘)</div><div class="muted">KRW</div></div>
        <div class="bd kpi"><div>
          <div class="num" id="revToday">₩0</div>
          <div class="delta up" id="revDelta">+0.0% 전일대비</div>
        </div>
          <canvas class="spark" id="sparkRev" aria-label="Revenue sparkline" role="img"></canvas>
        </div>
      </div>
      <div class="card fade-in">
        <div class="hd"><div class="title">신규 가입</div><div class="muted">오늘</div></div>
        <div class="bd kpi"><div>
          <div class="num" id="newUsers">0</div>
          <div class="delta up" id="userDelta">+0.0% 주간</div>
        </div>
          <canvas class="spark" id="sparkUsers"></canvas>
        </div>
      </div>
      <div class="card fade-in">
        <div class="hd"><div class="title">결제 성공률</div><div class="muted">최근 1시간</div></div>
        <div class="bd kpi"><div>
          <div class="num" id="payRate">0%</div>
          <div class="delta up" id="payDelta">+0.0% 추세</div>
        </div>
          <canvas class="spark" id="sparkRate"></canvas>
        </div>
      </div>
      <div class="card fade-in">
        <div class="hd"><div class="title">시스템 가용성</div><div class="muted">24h</div></div>
        <div class="bd kpi"><div>
          <div class="num" id="uptime">100.00%</div>
          <div class="delta up" id="uptimeDelta">SLA 정상</div>
        </div>
          <canvas class="spark" id="sparkUptime"></canvas>
        </div>
      </div>
    </section>

    <!-- CHART + SUMMARY CARDS -->
    <section class="grid cards">
      <div class="card">
        <div class="hd">
          <div>
            <div class="title">월간 매출 추이</div>
            <div class="muted">부가세 제외, 통화 KRW</div>
          </div>
          <div class="toolbar">
            <button class="btn" data-range="3m">3M</button>
            <button class="btn" data-range="6m">6M</button>
            <button class="btn" data-range="12m">12M</button>
          </div>
        </div>
        <div class="bd"><canvas id="chartRevenue" height="200"></canvas></div>
        <div class="divider"></div>
        <div class="bd" id="revSummary">-</div>
      </div>

      <div class="card">
        <div class="hd">
          <div>
            <div class="title">채널별 전환율</div>
            <div class="muted">최근 30일</div>
          </div>
        </div>
        <div class="bd"><canvas id="chartDonut" height="220" aria-label="채널 구성 도넛" role="img"></canvas></div>
        <div class="divider"></div>
        <div class="bd">
          <div class="status ok">광고 효율 ↑</div>
          <div class="muted">리타게팅 캠페인 최적화 영향</div>
        </div>
      </div>
    </section>

    <!-- PANELS -->
    <section class="grid panels">
      <div class="card">
        <div class="hd"><div class="title">시스템 상태</div>
          <div class="toolbar">
            <span class="status ok">모든 지역 정상</span>
          </div>
        </div>
        <div class="bd">
          <table class="table" aria-label="시스템 상태 테이블">
            <thead>
              <tr><th>서비스</th><th>리전</th><th>지연(ms)</th><th>에러율</th><th>상태</th></tr>
            </thead>
            <tbody id="sysTable"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="hd"><div class="title">작업 & 알림</div></div>
        <div class="bd">
          <div class="timeline" id="timeline">
            <!-- timeline items injected -->
          </div>
          <div class="divider"></div>
          <div>
            <label><input type="checkbox"/> 주간 리포트 자동 발송</label>
            <br/>
            <label><input type="checkbox" checked/> 장애 대응 온콜 배정</label>
          </div>
        </div>
      </div>
    </section>

    <!-- TABLE -->
    <section class="card">
      <div class="hd">
        <div>
          <div class="title">최근 트랜잭션</div>
          <div class="muted">승인·환불·실패 포함 (최대 500건)</div>
        </div>
        <div class="toolbar">
          <input id="filterInput" class="btn" style="min-width:200px" placeholder="고객/주문ID 필터"/>
          <button id="sortAmount" class="btn">금액 정렬</button>
          <button id="sortDate" class="btn">시간 정렬</button>
        </div>
      </div>
      <div class="bd" style="overflow:auto; max-height:480px">
        <table class="table" id="txTable" aria-label="거래 테이블">
          <thead><tr>
            <th>#</th>
            <th>시간</th>
            <th>주문 ID</th>
            <th>고객</th>
            <th>채널</th>
            <th>금액</th>
            <th>상태</th>
          </tr></thead>
          <tbody id="txBody"></tbody>
        </table>
      </div>
    </section>

    <div class="footer">© <span id="year"></span> Acme, Inc. · 빌드 v1.0.0</div>
  </main>
</div>

<script>
  // ---------- THEME ----------
  const root = document.documentElement;
  const saved = localStorage.getItem('theme');
  if(saved === 'light'){ root.classList.add('light'); }
  document.getElementById('darkToggle').onclick = () => {
    root.classList.toggle('light');
    localStorage.setItem('theme', root.classList.contains('light') ? 'light' : 'dark');
  };

  // ---------- SIDEBAR TOGGLE (mobile) ----------
  const sidebar = document.getElementById('sidebar');
  document.getElementById('openSidebar').onclick = () => sidebar.classList.toggle('open');

  // ---------- UTIL ----------
  const fmtKRW = v => '₩' + v.toLocaleString('ko-KR');
  const clamp = (v, mi, ma) => Math.max(mi, Math.min(ma, v));
  const rand = (mi, ma) => Math.floor(Math.random()*(ma-mi+1))+mi;
  const now = new Date();
  document.getElementById('year').textContent = now.getFullYear();

  function spark(el, arr, color){
    const c = document.getElementById(el); const w = c.width = c.clientWidth; const h = c.height = c.clientHeight; const ctx=c.getContext('2d');
    const max = Math.max(...arr), min = Math.min(...arr);
    const x = (i)=> i*(w/(arr.length-1));
    const y = (v)=> h - ( (v-min)/(max-min || 1) )*h;
    ctx.clearRect(0,0,w,h);
    // gradient line
    const g = ctx.createLinearGradient(0,0,0,h);
    g.addColorStop(0, color);
    g.addColorStop(1, 'transparent');
    // area
    ctx.beginPath(); ctx.moveTo(0,h);
    arr.forEach((v,i)=> ctx.lineTo(x(i), y(v)) );
    ctx.lineTo(w,h); ctx.closePath(); ctx.fillStyle = g; ctx.fill();
    // line
    ctx.beginPath(); ctx.lineWidth=2; ctx.strokeStyle = color; ctx.moveTo(0, y(arr[0]));
    arr.forEach((v,i)=> ctx.lineTo(x(i), y(v)) ); ctx.stroke();
  }

  function lineChart(el, data){
    const c = document.getElementById(el), ctx=c.getContext('2d'); const w=c.width=c.clientWidth; const h=c.height=c.clientHeight; ctx.clearRect(0,0,w,h);
    const max = Math.max(...data), min=Math.min(...data);
    const pad=30; const innerW=w-pad*2; const innerH=h-pad*2;
    const X=i=> pad + i*(innerW/(data.length-1));
    const Y=v=> pad + innerH - ((v-min)/(max-min||1))*innerH;
    // axes
    ctx.strokeStyle='rgba(255,255,255,.15)'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(pad,pad); ctx.lineTo(pad,h-pad); ctx.lineTo(w-pad,h-pad); ctx.stroke();
    // grid
    ctx.font='12px system-ui'; ctx.fillStyle='var(--muted)';
    for(let i=0;i<5;i++){ const y=pad + i*(innerH/4); ctx.strokeStyle='rgba(255,255,255,.06)'; ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(w-pad,y); ctx.stroke(); }
    // area gradient
    const g = ctx.createLinearGradient(0,pad,0,h-pad); g.addColorStop(0,'rgba(106,167,255,.6)'); g.addColorStop(1,'rgba(106,167,255,0)');
    ctx.beginPath(); ctx.moveTo(X(0),Y(data[0])); for(let i=1;i<data.length;i++){ ctx.lineTo(X(i),Y(data[i])); }
    ctx.lineTo(w-pad,h-pad); ctx.lineTo(pad,h-pad); ctx.closePath(); ctx.fillStyle=g; ctx.fill();
    // line
    ctx.beginPath(); ctx.lineWidth=2; ctx.strokeStyle='var(--brand)'; ctx.moveTo(X(0),Y(data[0])); for(let i=1;i<data.length;i++){ ctx.lineTo(X(i),Y(data[i])); } ctx.stroke();
  }

  function donutChart(el, vals, labels){
    const c=document.getElementById(el); const ctx=c.getContext('2d'); const w=c.width=c.clientWidth; const h=c.height=c.clientHeight; const r=Math.min(w,h)/2-10; const cx=w/2, cy=h/2;
    const total = vals.reduce((a,b)=>a+b,0);
    const palette=['#6aa7ff','#8ad0ff','#22c55e','#f59e0b','#ef4444','#a78bfa'];
    let start=-Math.PI/2;
    ctx.clearRect(0,0,w,h);
    vals.forEach((v,i)=>{ const ang = (v/total)*Math.PI*2; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.fillStyle=palette[i%palette.length]; ctx.arc(cx,cy,r,start,start+ang); ctx.closePath(); ctx.fill(); start+=ang; });
    // inner hole
    ctx.globalCompositeOperation='destination-out'; ctx.beginPath(); ctx.arc(cx,cy,r*0.6,0,Math.PI*2); ctx.fill(); ctx.globalCompositeOperation='source-over';
    // legend
    const legX=10, legY=10; ctx.font='12px system-ui';
    labels.forEach((lb,i)=>{ const y=legY+i*18; ctx.fillStyle=palette[i%palette.length]; ctx.fillRect(legX,y,10,10); ctx.fillStyle='var(--text)'; ctx.fillText(`${lb} ${(vals[i]/total*100).toFixed(1)}%`, legX+16, y+10); });
  }

  // ---------- MOCK DATA ----------
  const kpi = {
    rev: Array.from({length:24}, (_,i)=> 700 + i*rand(8,15) + rand(-40,40)),
    users: Array.from({length:24}, (_,i)=> 50 + rand(0,30)),
    rate: Array.from({length:24}, (_,i)=> clamp(92 + Math.sin(i/3)*4 + rand(-1,1), 85, 99)),
    up: Array.from({length:24}, ()=> clamp(99.8 + Math.random()*0.2, 99.7, 100))
  };

  // ---------- INIT KPIs ----------
  function initKpis(){
    const todayRev = kpi.rev.slice(-6).reduce((a,b)=>a+b,0)*1000; // pretend KRW
    const prevRev = kpi.rev.slice(-12,-6).reduce((a,b)=>a+b,0)*1000;
    const delta = ((todayRev-prevRev)/prevRev*100)||0;
    document.getElementById('revToday').textContent = fmtKRW(todayRev);
    document.getElementById('revDelta').textContent = `${delta>=0?'+':''}${delta.toFixed(1)}% 전일대비`;
    document.getElementById('revDelta').className = `delta ${delta>=0?'up':'down'}`;
    spark('sparkRev', kpi.rev, 'rgba(106,167,255,1)');

    const nu = kpi.users.slice(-6).reduce((a,b)=>a+b,0);
    const nuPrev = kpi.users.slice(-12,-6).reduce((a,b)=>a+b,0);
    const nuDelta = ((nu-nuPrev)/nuPrev*100)||0;
    document.getElementById('newUsers').textContent = nu.toString();
    document.getElementById('userDelta').textContent = `${nuDelta>=0?'+':''}${nuDelta.toFixed(1)}% 주간`;
    document.getElementById('userDelta').className = `delta ${nuDelta>=0?'up':'down'}`;
    spark('sparkUsers', kpi.users, 'rgba(34,197,94,1)');

    const rate = kpi.rate.at(-1);
    const rateDelta = rate - kpi.rate.at(-2);
    document.getElementById('payRate').textContent = rate.toFixed(1)+'%';
    document.getElementById('payDelta').textContent = `${rateDelta>=0?'+':''}${rateDelta.toFixed(1)}% 추세`;
    spark('sparkRate', kpi.rate, 'rgba(245,158,11,1)');

    const up = kpi.up.at(-1);
    document.getElementById('uptime').textContent = up.toFixed(2)+'%';
    document.getElementById('uptimeDelta').textContent = up>99.9 ? 'SLA 정상' : '주의 요망';
    spark('sparkUptime', kpi.up, 'rgba(138,208,255,1)');
  }

  // ---------- REVENUE CHART ----------
  const revenue12m = Array.from({length:12}, ()=> rand(48000, 120000));
  function refreshRevenue(range){
    const len = range==='3m'?3: range==='6m'?6: 12;
    const arr = revenue12m.slice(-len);
    lineChart('chartRevenue', arr);
    const sum = arr.reduce((a,b)=>a+b,0); const avg = sum/arr.length;
    const mom = ((arr.at(-1)-arr.at(-2))/arr.at(-2)*100)||0;
    document.getElementById('revSummary').innerHTML = `
      <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap">
        <span class="status ok">총액 ${fmtKRW(sum*1000)}</span>
        <span class="status">평균 ${fmtKRW(Math.round(avg)*1000)}</span>
        <span class="status ${mom>=0?'ok':'bad'}">MoM ${mom>=0?'+':''}${mom.toFixed(1)}%</span>
      </div>`;
  }

  // ---------- DONUT ----------
  const channels = ['Direct','Organic','Ads','Email','Affiliate'];
  let channelVals = [24, 32, 28, 9, 7];

  // ---------- SYSTEM TABLE ----------
  const systems = [
    {svc:'API Gateway', region:'ap-northeast-2', lat:rand(22,40), err:rand(0,1)/100},
    {svc:'Payments', region:'ap-northeast-2', lat:rand(40,65), err:rand(0,2)/100},
    {svc:'User DB', region:'ap-northeast-2', lat:rand(8,20), err:rand(0,1)/1000},
    {svc:'Search', region:'ap-southeast-1', lat:rand(25,45), err:rand(0,2)/100},
    {svc:'Realtime', region:'us-west-2', lat:rand(85,110), err:rand(1,4)/100},
    {svc:'Emails', region:'eu-west-1', lat:rand(60,90), err:rand(0,1)/100}
  ];

  function renderSys(){
    const el = document.getElementById('sysTable'); el.innerHTML='';
    systems.forEach(s=>{
      const tr=document.createElement('tr');
      const st = s.err<0.01? 'ok' : s.err<0.02? 'warn' : 'bad';
      tr.innerHTML = `<td>${s.svc}</td><td>${s.region}</td><td>${s.lat}</td><td>${(s.err*100).toFixed(2)}%</td><td><span class="status ${st}">${st==='ok'?'정상': st==='warn'?'주의':'장애'}</span></td>`;
      el.appendChild(tr);
    });
  }

  // ---------- TIMELINE ----------
  const tl = [
    {t:'10:12', text:'결제 장애 감지(일시적) — 재시도 성공률 자동 튜닝 적용', sev:'warn'},
    {t:'09:40', text:'신규 릴리즈 v1.0.0 배포 완료 (blue→green 전환)', sev:'ok'},
    {t:'09:05', text:'ETL 배치 지연 — SLA 영향 없음', sev:'warn'},
    {t:'08:10', text:'보안 규칙 업데이트 (WAF)', sev:'ok'},
  ];
  function renderTimeline(){
    const el=document.getElementById('timeline'); el.innerHTML='';
    tl.forEach(i=>{
      const row=document.createElement('div'); row.className='tl-item';
      row.innerHTML = `<div class="tl-dot"></div><div style="margin-left:18px"><div style="display:flex; gap:8px; align-items:center"><b>${i.t}</b> <span class="status ${i.sev==='ok'?'ok': i.sev==='warn'?'warn':'bad'}">${i.sev.toUpperCase()}</span></div><div class="muted">${i.text}</div></div>`;
      el.appendChild(row);
    });
  }

  // ---------- TRANSACTIONS ----------
  const first=['김','이','박','최','정','한','조','윤','장','임'];
  const last=['민수','서연','지훈','하준','도현','지우','예린','현우','유진','가영'];
  function name(){ return first[rand(0,first.length-1)]+last[rand(0,last.length-1)]; }
  function id(){ return 'ORD-'+rand(2024000000,2024999999); }
  const channelsTbl=['web','ios','android','partner','api'];
  const statuses=['승인','환불','실패'];

  const tx = Array.from({length:120}, (_,i)=>{
    const amt = rand(1200, 900000);
    const st = statuses[rand(0, statuses.length-1)];
    const ts = new Date(Date.now() - rand(0, 1000*60*60*24*3));
    return {idx:i+1, time:ts, id:id(), name:name(), ch:channelsTbl[rand(0,4)], amt, st};
  });

  let txSort = {key:'time', dir:'desc'};

  function renderTx(list){
    const body=document.getElementById('txBody'); body.innerHTML='';
    list.forEach(t=>{
      const tr=document.createElement('tr');
      const stClass = t.st==='승인'?'ok': t.st==='환불'?'warn':'bad';
      tr.innerHTML = `<td>${t.idx}</td><td>${t.time.toLocaleString('ko-KR')}</td><td>${t.id}</td><td>${t.name}</td><td>${t.ch}</td><td style="text-align:right">${fmtKRW(t.amt)}</td><td><span class="status ${stClass}">${t.st}</span></td>`;
      body.appendChild(tr);
    });
  }

  function sortTx(key){
    const dir = (txSort.key===key && txSort.dir==='asc') ? 'desc' : 'asc';
    txSort = {key, dir};
    const mul = dir==='asc'? 1 : -1;
    const copy=[...tx];
    copy.sort((a,b)=> (a[key]>b[key]?1:-1)*mul);
    renderTx(copy);
  }

  document.getElementById('sortAmount').onclick = ()=> sortTx('amt');
  document.getElementById('sortDate').onclick = ()=> sortTx('time');

  document.getElementById('filterInput').addEventListener('input', (e)=>{
    const q = e.target.value.toLowerCase();
    const filtered = tx.filter(t=> t.name.toLowerCase().includes(q) || t.id.toLowerCase().includes(q));
    renderTx(filtered);
  });

  // ---------- EXPORT CSV ----------
  document.getElementById('exportCsv').onclick = ()=>{
    const headers = ['index','time','order_id','customer','channel','amount','status'];
    const rows = tx.map(t=> [t.idx, t.time.toISOString(), t.id, t.name, t.ch, t.amt, t.st].join(','));
    const blob = new Blob([[headers.join(','), ...rows].join('\n')], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), {href:url, download:'transactions.csv'});
    a.click(); URL.revokeObjectURL(url);
  };

  // ---------- SEARCH BUTTON ----------
  document.getElementById('searchBtn').onclick = ()=>{
    const q = document.getElementById('q').value.trim();
    if(!q) return alert('검색어를 입력하세요.');
    const match = tx.find(t => t.id.includes(q) || t.name.includes(q));
    if(match){ alert(`첫 일치: ${match.id} / ${match.name}`); }
    else { alert('일치하는 결과가 없습니다.'); }
  };

  // ---------- RANGE BUTTONS ----------
  document.querySelectorAll('[data-range]').forEach(btn=> btn.onclick = ()=> refreshRevenue(btn.dataset.range));

  // ---------- INIT ALL ----------
  function onResize(){
    spark('sparkRev', kpi.rev, 'rgba(106,167,255,1)');
    spark('sparkUsers', kpi.users, 'rgba(34,197,94,1)');
    spark('sparkRate', kpi.rate, 'rgba(245,158,11,1)');
    spark('sparkUptime', kpi.up, 'rgba(138,208,255,1)');
    refreshRevenue('12m');
    donutChart('chartDonut', channelVals, channels);
  }

  window.addEventListener('resize', onResize);

  initKpis();
  refreshRevenue('12m');
  donutChart('chartDonut', channelVals, channels);
  renderSys();
  renderTimeline();
  renderTx(tx);
  setTimeout(()=> document.querySelectorAll('.fade-in').forEach(e=> e.style.animationDelay=Math.random()/2+'s'), 0);
</script>
</body>
</html>
